apiVersion: v1
kind: Namespace
metadata:
  name: cypress
  labels:
    name: cypress
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cypress-pvc
  namespace: cypress
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: cypress-dashboard
  name: cypress-dashboard
  namespace: cypress
spec:
  strategy:
    type: Recreate
  replicas: 1
  selector:
    matchLabels:
      app: cypress-dashboard
  template:
    metadata:
      labels:
        app: cypress-dashboard
    spec:
      volumes:
        - name: cypress-data
          persistentVolumeClaim:
            claimName: cypress-pvc

      # https://docs.sorry-cypress.dev/configuration/persistent
      containers:
        - name: mongo
          image: mongo:4.2
          volumeMounts:
            - name: cypress-data
              subPath: mongo
              mountPath: /data/db
          ports:
            - containerPort: 27017
              protocol: TCP

        # https://docs.sorry-cypress.dev/configuration/director-configuration
        - name: director
          image: agoldis/sorry-cypress-director:latest
          env:
            - name: DASHBOARD_URL
              value: "https://dashboard.cypress.qa-de-1.cloud.sap"
            - name: EXECUTION_DRIVER
              value: "../execution/mongo/driver"
            - name: MONGODB_URI
              value: "mongodb://localhost:27017"
            - name: MONGODB_DATABASE
              value: "sorry-cypress"
            - name: SCREENSHOTS_DRIVER
              value: "../screenshots/minio.driver"
            - name: MINIO_ACCESS_KEY
              value: "blablabla"
            - name: MINIO_SECRET_KEY
              value: "foofoofoo"
            - name: MINIO_ENDPOINT
              value: "storage.cypress.qa-de-1.cloud.sap"
            - name: MINIO_URL
              value: "https://storage.cypress.qa-de-1.cloud.sap"
            - name: MINIO_PORT
              value: "443"
            - name: MINIO_USESSL
              value: "true"
            - name: MINIO_BUCKET
              value: "sorry-cypress"
          ports:
            - containerPort: 1234
              protocol: TCP

        # https://docs.sorry-cypress.dev/configuration/api-configuration
        - name: api
          image: agoldis/sorry-cypress-api:latest
          env:
            - name: MONGODB_URI
              value: "mongodb://localhost:27017"
            - name: MONGODB_DATABASE
              value: "sorry-cypress"
          ports:
            - containerPort: 4000
              protocol: TCP

        # https://docs.sorry-cypress.dev/configuration/dashboard-configuration/configuration
        - name: dashboard
          image: agoldis/sorry-cypress-dashboard:latest
          env:
            - name: GRAPHQL_SCHEMA_URL
              value: "https://api.cypress.qa-de-1.cloud.sap"
            - name: GRAPHQL_CLIENT_CREDENTIALS
              value: ""
            - name: PORT
              value: "8080"
            - name: CI_URL
              value: ""
          ports:
            - containerPort: 8080
              protocol: TCP

        # https://docs.sorry-cypress.dev/configuration/director-configuration/minio-configuration
        - name: storage
          image: minio/minio
          args: ["server", "/data"]
          env:
            - name: MINIO_ACCESS_KEY
              value: "blablabla"
            - name: MINIO_SECRET_KEY
              value: "foofoofoo"
          volumeMounts:
            - name: cypress-data
              subPath: minio
              mountPath: /data
          ports:
            - containerPort: 9000
              protocol: TCP

        # this is to create the sorry cypress bucket for first time
        - name: createbuckets
          image: minio/mc
          command:
            [
              "/bin/sh",
              "-c",
              "sleep 10; /usr/bin/mc config host add myminio http://localhost:9000 blablabla foofoofoo; /usr/bin/mc rm -r --dangerous --force myminio/sorry-cypress; /usr/bin/mc mb myminio/sorry-cypress; /usr/bin/mc policy set download myminio/sorry-cypress; /usr/bin/mc policy set public myminio/sorry-cypress; tail -f /dev/null",
            ]

---
kind: Service
apiVersion: v1
metadata:
  namespace: cypress
  name: cypress-service
spec:
  selector:
    app: cypress-dashboard
  ports:
    - name: cypress-api
      port: 4000
      protocol: TCP
    - name: cypress-dasboard
      port: 8080
      protocol: TCP
    - name: cypress-director
      port: 1234
      protocol: TCP
    - name: cypress-storage
      port: 9000
      protocol: TCP
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: cypress-ingress
  namespace: cypress
  annotations:
    kubernetes.io/ingress.class: nginx
    kubernetes.io/tls-acme: "true"
spec:
  tls:
    - hosts:
        - "*.cypress.qa-de-1.cloud.sap"
      secretName: tls-cypress-ingress
  rules:
    - host: api.cypress.qa-de-1.cloud.sap
      http:
        paths:
          - path: /
            backend:
              serviceName: cypress-service
              servicePort: 4000
    - host: dashboard.cypress.qa-de-1.cloud.sap
      http:
        paths:
          - path: /
            backend:
              serviceName: cypress-service
              servicePort: 8080
    - host: director.cypress.qa-de-1.cloud.sap
      http:
        paths:
          - path: /
            backend:
              serviceName: cypress-service
              servicePort: 1234
    - host: storage.cypress.qa-de-1.cloud.sap
      http:
        paths:
          - path: /
            backend:
              serviceName: cypress-service
              servicePort: 9000
