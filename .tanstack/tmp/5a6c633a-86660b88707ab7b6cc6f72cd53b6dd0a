import { createFileRoute, useNavigate } from "@tanstack/react-router"
import type { ApiResponse } from "../types/api"
import { JobDetails } from "./jobs/-components/JobDetails"
import { Spinner, Button, ButtonRow, Panel } from "@cloudoperators/juno-ui-components"

export const Route = createFileRoute("/$jobId")({
  component: Details,
  pendingComponent: () => <Spinner size="small" aria-label="Loading Job Details" />,
  loader: async ({ context, params }) => {
    const client = context.apiClient
    if (!client) {
      throw new Error("API client is undefined")
    }
    const response = await client.get<ApiResponse>(`/jobs/${params.jobId}`)
    if (!response.data.success) {
      throw new Error(response.data.error?.message || "Failed to fetch job details")
    }
    const job = response.data.job
    if (!job) {
      throw new Error("Job not found")
    }
    return { job, domainName: context.domainName, projectName: context.projectName }
  },
})

function Details() {
  const { job, domainName, projectName } = Route.useLoaderData()
  const navigate = useNavigate()

  const handleClose = () => {
    navigate({ to: "/jobs" })
  }

  return (
    <Panel opened={true} title={`Job Details: ${job.name}`} onClose={handleClose}>
      <JobDetails job={job} domainName={domainName} projectName={projectName} />
      <ButtonRow>
        <Button label="Close" onClick={handleClose} />
      </ButtonRow>
    </Panel>
  )
}
